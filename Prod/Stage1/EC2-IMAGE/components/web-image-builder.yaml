name: ImageBuilder-AnsibleWeb
description: Build Image using Ansible
schemaVersion: 1.0

phases:
  - name: build
    steps:
      - name: install_ssm_agent
        action: ExecuteBash
        inputs:
          commands:
            - sudo dnf install -y https://s3.amazonaws.com/amazon-ssm-us-east-1/latest/linux_amd64/amazon-ssm-agent.rpm
            - sudo systemctl enable amazon-ssm-agent
            - sudo systemctl start amazon-ssm-agent
      - name: update_and_install
        action: ExecuteBash
        inputs:
          commands:
            - dnf -y update
            - dnf -y install ansible python3 git
            - ansible-galaxy collection install ansible.posix community.general

      - name: clone_and_run_playbook
        action: ExecuteBash
        inputs:
          commands:
            # Clone your repo (adjust if repo name is different)
            - git clone https://github.com/rootacces77/terraform-project1 /tmp/terraform-project1

            # Go into the Ansible directory and run playbook locally on this instance
            - cd /tmp/terraform-project1/ec2-webserver-ansible
            - ansible-playbook playbooks/main.yml

      - name: cleanup
        action: ExecuteBash
        inputs:
          commands:
            - dnf -y remove ansible git
            - rm -rf /tmp/terraform-project1